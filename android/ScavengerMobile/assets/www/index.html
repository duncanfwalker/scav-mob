<!DOCTYPE html>
<html class="ui-mobile">
<head>
<title>Scavenger Mobile</title>

<meta name="viewport" content="width=device-width, initial-scale=1; user-scalable=0;" />

<script type="text/javascript" charset="utf-8" src="libs/cordova-2.2.0.js"></script>
<script type="text/javascript" charset="utf-8" src="libs/jquery-1.8.3.js"></script>
<script type="text/javascript" charset="utf-8" src="libs/jquery.mobile-1.2.0.js"></script>
<script type="text/javascript" charset="utf-8" src="libs/cdv-plugin-fb-connect.js"></script>
<script type="text/javascript" charset="utf-8" src="libs/facebook_js_sdk.js"></script>
<script type="text/javascript" charset="utf-8" src="libs/hogan-2.0.0.js"></script>

<script type="text/javascript" charset="utf-8" src="js/scav-connect.js"></script>
<script type="text/javascript" charset="utf-8" src="js/item.js"></script>
<script type="text/javascript" charset="utf-8" src="js/SettingsList.js"></script>
<script type="text/javascript" charset="utf-8" src="js/StartupView.js"></script>


<link rel="stylesheet" type="text/css" href="css/jquery.mobile-1.2.0.min.css" />
<link rel="stylesheet" type="text/css" href="css/scavenger.css" />


</head>
<body>
	<div id="action-bar" data-id="action" data-theme="a" data-role="header"
		data-position="fixed" role="header">
		<h1 id="title"></h1>
		<a href="#give" class="give-button">G</a> <!--  <a href="#take">S</a>--> <a href="#me">&lt;</a>

	</div>


	<div id="fb-root"></div>
	<div id="log"></div>

	<div id="data"></div>
	<div title="Give" data-role="page" id="give">

		<div data-role="content">
			<!--<a id="facebook-login" data-role="button">Facebook login dialog</a>
				  <a href="#login" id="scavenger-login" data-rel="dialog" data-role="button">Mobile Login</a>  -->
			<form id="give-item" action="">
				<fieldset id="new-item-image" class="ui-body-b">
					<!--data-type="horizontal" -->
					<div id="new-item-image-preview">
						<img style="padding: 20px 0;" class="image-placeholder"
							src="http://codiqa.com/static/images/v2/image.png" alt="image" />

						<img style="display: none; width: 95%;" id="smallImage" src="" />
						<div id="progress-bar"
							style="height: 10px; width: 0; background-color: red;"></div>
					</div>
					<div id="image-chooser" class="new-item-image-controls"
						data-role="controlgroup">
						<a id="photo-get-new" data-role="button" data-transition="none"
							href="#page1" data-theme="c">Capture </a> <a
							id="photo-get-existing" data-role="button" data-transition="none"
							href="#page1" data-theme="c">Browse</a>
					</div>
					<div id="image-editor" data-role="controlgroup" class="ui-body-c"
						data-type="horizontal">
						<a id="photo-clear" data-role="button" data-icon="delete"
							data-transition="none" href="#page1" data-theme="c">Clear </a> <a
							id="photo-rotate" data-role="button" data-icon="forward"
							data-transition="none" href="#page1" data-theme="c">Rotate</a>
					</div>
				</fieldset>

				<fieldset data-role="controlgroup" data-mini="true">
					<label for="title"> </label> <input name="title" id="title"
						placeholder="Title" value="" type="text" />
				</fieldset>

				<fieldset data-role="controlgroup" data-mini="false">
					<label for="description"> </label>
					<textarea name="description" id="description"
						placeholder="Description" data-rows="20" row="20"></textarea>
				</fieldset>
				<!--	
				<div data-role="collapsible-set">
					<div data-role="collapsible" data-collapsed="true">
					<h3>Advanced Options</h3>
						<div data-role="fieldcontain">
							<label for="selectmenu1"> </label> <select name=""
								data-mini="true">
								<option value="option1">Baby Items (0 - 2 years)</option>
							</select>
						</div>
						<div data-role="fieldcontain">
							<fieldset data-role="controlgroup" data-mini="true">
								<label for="slider1"> Remove my item after </label> <input
									type="range" name="slider" value="30" min="0" max="60"
									data-highlight="true" />
							</fieldset>
						</div>
					</div>
				</div> -->


				<input id="offer-item" type="submit" data-theme="b"
					data-icon="arrow-r" data-iconpos="right" value="Offer this now" />
			</form>
		</div>
	</div>

	<div title="Take" data-role="page" id="take">
	
		<div data-role="content">
			<div id="search-results">
				<ul class="offer-list" data-role="listview">
					<li></li>
				</ul>
			</div>
			</div>
	</div>

	<div title="Me" data-role="page" id="me">
	
			<div data-role="content">
			<div id="search-results">
				<ul class="offer-list" data-role="listview">
					<li></li>
				</ul>
			</div>
			</div>
	
	
	</div>



	<div title="Login" id="login" data-role="page">
		<div data-role="header" data-theme="d">
			<h1>Login</h1>
		</div>
		<div id="infoMessage"></div>
		<form id="login-form" method="post" accept-charset="utf-8">
		<!--  	<p><label for="identity">Email/Username:</label><input type="text"	name="identity" value="" id="identity"></p>
			<p><label for="password">Password:</label><input type="password"name="password" value="" id="password"></p>
	-->
		
		
			<div id="log"></div>
		</form>
	</div>
	
	
	
<div id="templates">	


	<script id="template-setting" type="text/x-hogan-template">
{{#fields}}
	<p><label for="{{id}}">{{label}}</label>
	<{{tag}} type="{{type}}"	name="{{id}}" value="" id="{{id}}" data-role="{{role}}"> 
	  {{#options}}<option value="{{value}}">{{option}}</option>{{/options}}
	</{{tag}}></p>
{{/fields}}
	</script>		
</div>
	
	
	
	
	
	
	<script>

var new_item = new Item();



$( document ).on( "mobileinit", function() {
    // Make your jQuery Mobile framework configuration changes here!
	$.support.cors = true;
    $.mobile.allowCrossDomainPages = true;
});





// Wait for Cordova to connect with the device
document.addEventListener("deviceready",onDeviceReady,false);




    
var friendIDs = [];
var fdata;
var pictureSource;   // picture source
var destinationType; // sets the format of returned value 
var destinationImageURI;
var access_token = "1274brad1274brad1274brad1274brad";
var BASE_URL = "http://dev.scavenger.org.uk/api";
var item_id;





/********************
Apply controllers to view 
*********************/  
$("#photo-get-new").click(function(event) {
   navigator.camera.getPicture(function (imageURI) { 
          new_item.image_local_uri  =  imageURI;
          showThumb(imageURI);
          new_item.sync($(event.target));
          }, function () {}, { 
      quality: 50,  targetWidth: 400, targetHeight: 400,  destinationType: destinationType.FILE_URI 
      }); //getpicture
}); //click

$("#photo-get-existing").click(function(event) {
   navigator.camera.getPicture(function (imageURI) { 
          new_item.image_local_uri =  imageURI;
          showThumb(imageURI);
          new_item.sync($(event.target));
          }, function () {}, {                                                                                                 
      quality: 50, destinationType: destinationType.FILE_URI,  sourceType: pictureSource.PHOTOLIBRARY
    }); //get picture
}); // click




$('#give-item input, #give-item textarea').change(function(event) {
//  var update_params = [];
//  update_params.push(event.target.id);
console.log("call S	-	Y	-	N	-	C ");
  new_item.sync($(event.target));
  

});




$("#facebook-login").click(function() {
   FB.login(
     function(response) {
       if (response.session) {
       alert('logged in');
       } else {
       alert('not logged in');
       }
     },
     { scope: "email" }
     );
}); // click

$("#offer-item").click(function(event) {
    event.preventDefault();
    new_item.publish();
    

    
    
    
    
    
    alert("Thanks for offering!");
     clearThumb();
   // $('#give-item').reset();
   // $.mobile.changePage($('#give'));
  //  new_item = new Item();  
}); // click

$('#photo-clear').click(function(event) {
  clearThumb();
}); // click







$('#me').live('pageshow', function (event, ui) {
  $.mobile.loading('show',{
  	text: 'Loading...',
  	textVisible: true,
  	theme: 'b',
  });
  $.ajaxSetup({ cache: false });
	$.getJSON(encodeURI(BASE_URL+"/item/item_list"+ '?' + Math.round(new Date().getTime())), null,renderItems);
     
}); // show




function newItem() {
  $.post(  BASE_URL+"/item/item_update", 
  			   update_params,
		       function(data) { console.log("updated ok"); } ,
		       function(data) { console.log("failed to update"); } 
  );  
}



function onDeviceReady() {

	navigator.splashscreen.hide();
	
	

    pictureSource=navigator.camera.PictureSourceType;
    destinationType=navigator.camera.DestinationType;

    try {
    	if ((typeof cordova == 'undefined') && (typeof Cordova == 'undefined')) alert('Cordova variable does not exist. Check that you have included cordova.js correctly');
		if (typeof CDV == 'undefined') alert('CDV variable does not exist. Check that you have included cdv-plugin-fb-connect.js correctly');
		if (typeof FB == 'undefined') alert('FB variable does not exist. Check that you have included the Facebook JS SDK file.');
		       
	/* 	FB.Event.subscribe('auth.login', function(response) {
		                   alert('auth.login event');
		                   });
		
		FB.Event.subscribe('auth.logout', function(response) {
		                   alert('auth.logout event');
		                   });
		        
		FB.Event.subscribe('auth.sessionChange', function(response) {
		                   alert('auth.sessionChange event');
		                   });
		
		FB.Event.subscribe('auth.statusChange', function(response) {
		                   alert('auth.statusChange event');
		                   }); */
		    
    

    	 FB.init({ appId: "168526436623358", nativeInterface: CDV.FB, useCachedDialogs: false });
    	 
    	 FB.login(function () {
	    	 FB.api('/me', function(response) {
			     console.log('me ' + JSON.stringify(response) + '.');
			 });
		 }, {scope: 'email,read_friendlists,publish_stream'});
    	 
    	/* FB.login(function(response) {
 			console.log('login , ' + JSON.stringify(response) + '.');
        }); */
    	 
		 
		 
        console.log("=====FACEBOOK LOGIN======");
 
    } catch (e) {
      console.log("login failed");
      console.log(e);
    }
                                      
}

function clearThumb() {

  $('#smallImage').css("display","none");
  $('.image-placeholder').show();
  $('#image-chooser').show();
  $('#image-editor').hide();
  $('#new-item-image-preview').width('29%');
  $('#smallImage').attr("src","");
}

function showThumb(imageURI) {
  $('#smallImage').css("display","block");
  $('.image-placeholder').hide();
  $('#image-chooser').hide();
  $('#image-editor').show();
  $('#new-item-image-preview').width('100%');
  $('#smallImage').attr("src",imageURI);

}

/********************
Apply controllers to view 
*********************/ 

function renderItems(items) {
        $('#me .offer-list').html('');

       $.each(items, function(index) {
       
       
			$('#me .offer-list').append($('<li/>', { //build a li element
			    html: $('<a/>', { //with a A element inside it
			            href: items[index].datafile, //set the href for the link
			            'data-rel': 'dialog',
			            html: '<img class"ui-li-icon" src="'
			            	   +items[index].datafile.substring(0, items[index].datafile.length - 4)
			            	   +'_thumb.jpg" />'
			            	   +'<h3 class="ui-li-heading">'
			            	   +items[index].keywords+ '</h3>'
			          })
			})); 
   
        });
        $('#me .offer-list').listview('refresh');
       $('#me .offer-list a').click(function () {
          $.mobile.loading('show',{
          	text: 'Loading item...',
          	textVisible: true,
          	theme: 'b',
          });
        });   /*  */
        

        console.log($('#me .offer-list').html());
        $.mobile.loading('hide');
}





 
 function testAPI() {
    console.log('Welcome!  Fetching your information.... ');
    FB.api('/me', function(response) {
        console.log('Good to see you, ' + response.name + '.');
    });
}
function onPhotoFail(error){
  console.log(error);
}








$('a').click( function (e) {
	if ( e.hash !="") {
		//e.preventDefault();
		//$('div[data-role=page]').hide();
		//$(this.hash).class();
		$('.action-bar a').removeClass('active');
		$(e.target).addClass('active');
		$('#title').html ( $(this.hash).attr('title'));
	//	$(this.hash).show();
	}
});
  </script>
</body>
</html>